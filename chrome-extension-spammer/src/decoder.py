#!/usr/bin/env python
# Author: Harli Aquino (c) 2017 Cyren, Inc. | CSP-CERT.ph
import re, sys, logging
LOGGING_LEVEL = logging.DEBUG
logging.basicConfig(level=LOGGING_LEVEL,
                    format='%(asctime)s - %(name)s : %(message)s',
                    datefmt='%Y-%m-%d %H:%M:%S',
                    stream=sys.stdout,
                    )
cipherPtn=re.compile(r'_\w{2}=(\{.*?\}),',re.S)
varPtn=re.compile(r'_\w{2}\.(\w+)')
dictPtn=re.compile(r'(\w+)(:[\'"].*?[\'"])')
catPtn=re.compile(r'"\+"')
def varCallback(match):
    global cipherDict
    return '"%s"'%cipherDict[match.group(1)]
if __name__ == '__main__':
    path = sys.argv[1]
    with open(path,'rb') as fh:
        fb=fh.read()
        fh.close()
    dictStr=dictPtn.sub(r'"\1"\2',cipherPtn.findall(fb)[0])
    cipherDict=eval(dictStr)
    db=varPtn.sub(varCallback, fb)
    with open('%s.decoded.js_'%path,'wb') as fh:
        fh.write(db)
        fh.close()
    db=catPtn.sub('',db)
    with open('%s.pretty.js_'%path,'wb') as fh:
        fh.write(db)
        fh.close()
    
